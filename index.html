<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Absensi QR</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link rel="manifest" href="manifest.json">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Absensi QR">

  <meta name="theme-color" content="#0d6efd">
</head>
<body>

<h2>Scan QR untuk Absensi</h2>

<input type="text" id="nama" placeholder="Nama"><br><br>
<input type="text" id="userid" placeholder="User ID"><br><br>

<button onclick="startScanner()">Scan Barcode</button><br><br>
<button onclick="restartScanner()">Scan ulang</button><br><br>

<div id="reader" style="width:300px"></div>

<p id="status"></p>

<script>
const OFFICE_LAT = -6.262405716030463;
const OFFICE_LNG = 106.58972588752822;
const MAX_RADIUS = 100; // meter

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lon2-lon1) * Math.PI/180;
  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

const qr = new Html5Qrcode("reader");

function onScanSuccess(decodedText) {
  const name = document.getElementById("nama").value;
  const userid = document.getElementById("userid").value;
    
  if (!name.trim()) {
    alert("Nama wajib diisi");
    return;
  }
  
  console.log("QR scanned:", decodedText);
  qr.stop();

  let qrData;
try {
  qrData = JSON.parse(decodedText);
} catch (e) {
  alert("QR tidak valid");
  return;
}

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    const jarak = getDistance(lat, lng, OFFICE_LAT, OFFICE_LNG);
    const status = jarak <= MAX_RADIUS ? "VALID" : "DI LUAR AREA";

    // const urlParams = new URLSearchParams(window.location.search);
    // const token = urlParams.get("token");
    // const API_URL = "https://script.google.com/macros/s/AKfycbym0TUkwd-tOcwxRkwbiebefQBk86uwQfaSmoj6wmX8-to-J4Nwb7xT-BzIvrdYP5FJ/exec";

    // fetch("https://script.google.com/macros/s/AKfycbym0TUkwd-tOcwxRkwbiebefQBk86uwQfaSmoj6wmX8-to-J4Nwb7xT-BzIvrdYP5FJ/exec", {
    //   method: "POST",
    //   body: JSON.stringify({
    //     token: token,
    //     nama: document.getElementById("nama").value,
    //     userid: document.getElementById("userid").value,
    //     lat,
    //     lng,
    //     jarak: Math.round(jarak)
    //   })
    // });

    // const qrData = JSON.parse(decodedText);

    fetch("https://absensi-backend.martinusdx001.workers.dev/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "ABSEN",
        token: qrData.token,
        nama: document.getElementById("nama").value,
        userid: document.getElementById("userid").value,
        lat,
        lng,
        jarak: Math.round(jarak)
      })
    })
    .then(res => res.json())
    .then(data => alert(data.result))
    .catch(err => {
        console.error(err);
        alert("Gagal kirim absensi");
    });

    document.getElementById("status").innerText =
      `Absensi ${status} (${Math.round(jarak)} m)`;
  });
}

function startScanner() {
    qr.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      onScanSuccess,
      errorMessage => {
        console.log("Scan error:", errorMessage);
      }
    );
}

function restartScanner() {
  qr.stop().then(() => {
    qr.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      onScanSuccess,
      errorMessage => {
        console.log("Scan error:", errorMessage);
      }
    );
  });
}


// new Html5Qrcode("reader")
//   .start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);

if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("Service Worker registered"));
}
</script>

</body>
</html>
